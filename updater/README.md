# 更新模块说明文档

## ⚠️ 重要警告：平台兼容性说明
当前更新功能主要在 Windows 平台上进行了充分测试，Linux 和 macOS 平台尚未经过全面验证，可能存在兼容性问题。


## 功能概述
本更新模块负责应用程序的自动更新功能，包含以下核心组件：

- **更新检测**：从远程服务器获取最新版本信息
- **更新下载**：下载更新包和更新程序
- **更新执行**：使用独立的更新程序替换旧版本

## 工作流程

1. **检测更新**：从 GitHub Releases 获取版本信息
2. **下载资源**：下载更新包和更新程序
3. **执行更新**：
    - 备份原程序目录
    - 删除原程序文件
    - 解压新版本文件
    - 启动新程序

## 常见问题及解决方案

### 1. 文件被占用问题（Windows）

#### 问题现象
```
Remove files failed: remove C:\Users\[用户名]\AppData\Local\LumenTV\app\*.jar: The process cannot access the file because it is being used by another process.
```


#### 问题原因
- 主应用程序进程仍在运行，部分文件被 JVM 锁定
- 文件句柄未完全释放

#### 解决方案
- **手动退出应用**：更新前确保主程序完全退出
- **权限检查**：确认对安装目录具有完全控制权限
- **重启后重试**：重启系统后重新执行更新

### 2. 权限不足问题

#### 问题现象
- 无法创建备份目录
- 无法删除旧文件
- 无法解压新文件

#### 解决方案
- **安装目录权限**：确保安装目录不在 `Program Files` 等受保护路径
- **运行权限**：以管理员身份运行安装程序
- **目录位置**：建议安装到用户目录如 `C:\Users\[用户名]\AppData\Local\LumenTV\`

### 3. 网络连接问题

#### 问题现象
- 无法下载更新包
- 更新程序获取失败

#### 解决方案
- 检查网络连接状态
- 配置代理服务器（如适用）
- 手动下载更新包并放置到指定缓存目录

### 4. 系统兼容性问题

#### 问题现象
- 更新程序无法执行
- 平台检测错误

#### 解决方案
- 确认操作系统版本支持
- 检查系统架构（x64/arm64）
- 验证系统依赖项完整性

## 最佳实践

### 安装目录要求
- **避免系统保护目录**：不要安装到 `C:\Program Files\` 等受保护路径
- **用户目录推荐**：使用 `%APPDATA%` 或 `%LOCALAPPDATA%` 目录
- **权限要求**：确保对安装目录具有读写执行权限

### 更新前准备
- **备份重要数据**：虽然会自动备份程序，但用户数据需自行备份
- **关闭相关程序**：确保没有其他实例在运行
- **网络稳定**：确保更新过程中的网络连接稳定

### 故障处理流程
1. **自动回滚**：更新失败时自动恢复备份
2. **手动恢复**：删除 `.backup` 后缀的备份目录并重命名
3. **重试机制**：重启系统后重新尝试更新

## 更新配置

### 缓存目录
- **Windows**: `%APPDATA%\Lumen-TV\cache\updater\`
- **Linux**: `~/.config/lumen-tv/cache/updater/`
- **macOS**: `~/Library/Application Support/lumen-tv/cache/updater/`

### 日志记录
- 更新过程中的关键操作会被记录到应用程序日志中
- 便于排查更新失败的具体原因

## 注意事项

- 更新过程中请勿手动干预或关闭更新窗口
- 如遇更新失败，系统会自动恢复到上一版本
- 建议在空闲时间执行更新，避免影响正常使用
- 更新完成后，旧版本备份会在成功启动新版本后自动清理