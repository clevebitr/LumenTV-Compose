name: set-tag
on:
  workflow_call:
    outputs:
      tag:
        description: "latest tag"
        value: ${{ jobs.set-tag.outputs.output1 }}
      lastTag:
        description: "last tag"
        value: ${{ jobs.set-tag.outputs.output2 }}

jobs:
  set-tag:
    name: set-tag
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ jobs.set-tag.outputs.tag }}
      lastTag: ${{ jobs.set-tag.outputs.lastTag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 获取最新标签
      - id: get-latest-tag
        run: echo "LATEST_TAG=$(git describe --tags --abbrev=0)" >> $GITHUB_OUTPUT

      # 获取上一个标签
      - id: get-last-tag
        run: echo "lastTag=$(git tag --sort=-creatordate | sed -n '2p')" >> $GITHUB_OUTPUT

      # 统一版本号生成逻辑
      - id: set-version
        run: |
          if [ "${{ github.ref }}" == "refs/heads/pre-release" ]; then
            echo "tag=${{ steps.get-latest-tag.outputs.LATEST_TAG }}-alpha.$(date +'%Y%m%d%H%M')" >> $GITHUB_OUTPUT
          else
            echo "tag=${{ steps.get-latest-tag.outputs.LATEST_TAG }}" >> $GITHUB_OUTPUT
          fi