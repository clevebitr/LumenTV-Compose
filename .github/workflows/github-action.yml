name: LumenTV Compose Build
on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]

jobs:
  set-tag:
    uses: ./.github/workflows/set-tag-workflow.yml

  build-updater:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            goos: linux
            goarch: amd64
            binary_name: updater-linux-amd64
          - os: ubuntu-latest
            goos: linux
            goarch: arm64
            binary_name: updater-linux-arm64
          - os: windows-latest
            goos: windows
            goarch: amd64
            binary_name: updater-windows-amd64.exe
          - os: macos-latest
            goos: darwin
            goarch: amd64
            binary_name: updater-macos-amd64
          - os: macos-latest
            goos: darwin
            goarch: arm64
            binary_name: updater-macos-arm64
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ¹ Set up Go environment
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: true

      - name: ðŸ”§ Build updater for ${{ matrix.goos }}/${{ matrix.goarch }}
        working-directory: ./updater
        shell: bash
        run: |
          echo "ðŸš€ å¼€å§‹æž„å»º updater: ${{ matrix.binary_name }}"
          echo "ðŸ–¥ï¸  ç›®æ ‡å¹³å°: ${{ matrix.goos }}/${{ matrix.goarch }}"
          
          go mod tidy
          echo "ðŸ“¦ Go modules å·²åŒæ­¥"
          
          BUILD_CMD="GOOS=${{ matrix.goos }} GOARCH=${{ matrix.goarch }} CGO_ENABLED=0 go build -ldflags=\"-s -w\" -o ../${{ matrix.binary_name }} ."
          echo "ðŸ”¨ æ‰§è¡Œæž„å»ºå‘½ä»¤: $BUILD_CMD"
          
          eval $BUILD_CMD
          
          if [ -f "../${{ matrix.binary_name }}" ]; then
            echo "âœ… Updater æž„å»ºæˆåŠŸ: ${{ matrix.binary_name }}"
            ls -la "../${{ matrix.binary_name }}"
            echo "ðŸ“ æ–‡ä»¶å¤§å°: $(du -h "../${{ matrix.binary_name }}" | cut -f1)"
          else
            echo "âŒ Updater æž„å»ºå¤±è´¥: ${{ matrix.binary_name }} æœªæ‰¾åˆ°"
            exit 1
          fi

      - name: ðŸ“¤ Upload updater artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.binary_name }}
          path: ./${{ matrix.binary_name }}
          retention-days: 1

  build-win:
    runs-on: windows-latest
    needs: [set-tag, build-updater]
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: 17
          cache: 'gradle'

      - name: ðŸ—ï¸ Build LumenTV Windows
        run: |
          echo "ðŸ”¨ å¼€å§‹æž„å»º LumenTV Windows ç‰ˆæœ¬"
          ./gradlew packageReleaseDistributionForCurrentOS
          ./gradlew createReleaseDistributable

      - name: ðŸ“¦ Package Windows application
        shell: pwsh
        run: |
          # ç§»åŠ¨ MSI æ–‡ä»¶åˆ°æ ¹ç›®å½•
          $msiPath = "./composeApp/build/compose/binaries/main-release/msi"
          if (Test-Path $msiPath) {
            Get-ChildItem -Path $msiPath -Filter "*.msi" | ForEach-Object {
              $newName = "LumenTV-win-${{ needs.set-tag.outputs.tag }}.msi"
              Move-Item $_.FullName "./$newName" -Force
              Write-Host "âœ… MSI æ–‡ä»¶å·²ç§»åŠ¨å¹¶é‡å‘½å: $newName"
            }
          } else {
            Write-Host "âš ï¸  MSI ç›®å½•ä¸å­˜åœ¨: $msiPath"
          }
          
          # åˆ›å»ºå¹¶ç§»åŠ¨ ZIP æ–‡ä»¶
          $appPath = "./composeApp/build/compose/binaries/main-release/app/LumenTV"
          if (Test-Path $appPath) {
            $zipName = "LumenTV-win-${{ needs.set-tag.outputs.tag }}.zip"
            Compress-Archive -Path "$appPath" -DestinationPath "./$zipName" -Force
            Write-Host "âœ… Windows ZIP åŒ…å·²åˆ›å»º: $zipName"
          } else {
            Write-Host "âŒ åº”ç”¨ç›®å½•ä¸å­˜åœ¨: $appPath"
            exit 1
          }

      - name: ðŸ“¤ Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: win-file
          path: |
            *.msi
            *.zip

  build-linux:
    runs-on: ubuntu-latest
    needs: [set-tag, build-updater]
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: 17
          cache: 'gradle'

      - name: ðŸ—ï¸ Build LumenTV Linux
        run: |
          chmod +x ./gradlew
          echo "ðŸ”¨ å¼€å§‹æž„å»º LumenTV Linux ç‰ˆæœ¬"
          ./gradlew packageReleaseDistributionForCurrentOS
          ./gradlew createReleaseDistributable

      - name: ðŸ“¦ Package Linux application
        run: |
          echo "1. ðŸ“¦ æž„å»º LumenTV Linux åŒ…"
          # ç§»åŠ¨ DEB æ–‡ä»¶åˆ°æ ¹ç›®å½•
          DEB_DIR="./composeApp/build/compose/binaries/main-release/deb"
          if [ -d "$DEB_DIR" ]; then
            find "$DEB_DIR" -name "*.deb" -exec sh -c 'mv "$1" "./LumenTV-linux-${{ needs.set-tag.outputs.tag }}.deb"' _ {} \;
            echo "âœ… DEB æ–‡ä»¶å·²ç§»åŠ¨å¹¶é‡å‘½å"
          else
            echo "âš ï¸ DEB ç›®å½•ä¸å­˜åœ¨: $DEB_DIR"
          fi
          
          # åˆ›å»ºå¹¶ç§»åŠ¨ ZIP æ–‡ä»¶
          echo "2. ðŸ“¦ æž„å»º LumenTV Linux ZIP åŒ…"
          APP_DIR="./composeApp/build/compose/binaries/main-release/app/LumenTV"
          if [ -d "$APP_DIR" ]; then
            ZIP_NAME="LumenTV-linux-${{ needs.set-tag.outputs.tag }}.zip"
            
            echo "ðŸ” æ£€æŸ¥åº”ç”¨ç›®å½•å†…å®¹:"
            ls -la "$APP_DIR"
            echo "ðŸ” å®Œæ•´è·¯å¾„æ£€æŸ¥:"
            pwd
            echo "APP_DIR å˜é‡å€¼: $APP_DIR"
          
            zip -j -q "./$ZIP_NAME" "$APP_DIR"/*
            echo "âœ… Linux ZIP åŒ…å·²åˆ›å»º: $ZIP_NAME"
            # éªŒè¯æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            if [ -f "$ZIP_NAME" ]; then
              echo "âœ… ZIP æ–‡ä»¶éªŒè¯é€šè¿‡: $(ls -lh $ZIP_NAME)"
            else
              echo "âŒ ZIP æ–‡ä»¶æœªæ‰¾åˆ°ï¼Œé‡æ–°å°è¯•"
              exit 1
            fi
          else
            echo "âŒ åº”ç”¨ç›®å½•ä¸å­˜åœ¨: $APP_DIR"
            exit 1
          fi

      - name: ðŸ“¤ Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-file
          path: |
            *.deb
            *.zip

  build-mac:
    runs-on: macos-latest
    needs: [set-tag, build-updater]
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: 17
          cache: 'gradle'

      - name: ðŸ—ï¸ Build LumenTV macOS
        run: |
          chmod +x ./gradlew
          echo "ðŸ”¨ å¼€å§‹æž„å»º LumenTV macOS ç‰ˆæœ¬"
          ./gradlew packageReleaseDistributionForCurrentOS

      - name: ðŸ—ï¸ Create distributable
        run: ./gradlew createReleaseDistributable

      - name: ðŸ“¦ Package macOS application
        run: |
          # ç§»åŠ¨ DMG æ–‡ä»¶åˆ°æ ¹ç›®å½•
          DMG_DIR="./composeApp/build/compose/binaries/main-release/dmg"
          if [ -d "$DMG_DIR" ]; then
            find "$DMG_DIR" -name "*.dmg" -exec sh -c 'mv "$1" "./LumenTV-mac-${{ needs.set-tag.outputs.tag }}.dmg"' _ {} \;
            echo "âœ… DMG æ–‡ä»¶å·²ç§»åŠ¨å¹¶é‡å‘½å"
          else
            echo "âš ï¸ DMG ç›®å½•ä¸å­˜åœ¨: $DMG_DIR"
          fi
          
          # åˆ›å»ºå¹¶ç§»åŠ¨ ZIP æ–‡ä»¶
          APP_PATH="./composeApp/build/compose/binaries/main-release/app/LumenTV.app"
          if [ -d "$APP_PATH" ]; then
            ZIP_NAME="LumenTV-mac-${{ needs.set-tag.outputs.tag }}.zip"
            zip -q -r "./$ZIP_NAME" "$APP_PATH"
            echo "âœ… macOS ZIP åŒ…å·²åˆ›å»º: $ZIP_NAME"
          else
            echo "âŒ åº”ç”¨ç›®å½•ä¸å­˜åœ¨: $APP_PATH"
            exit 1
          fi

      - name: ðŸ“¤ Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mac-file
          path: |
            *.dmg
            *.zip

  release:
    runs-on: ubuntu-latest
    needs: [ build-win, build-linux, build-mac, set-tag, build-updater ]
    steps:
      - name: ðŸ“¥ Download all artifacts
        uses: actions/download-artifact@v4

      - name: ðŸ“‹ Organize files for release
        run: |
          echo "ðŸ“‚ æ•´ç†å‘å¸ƒæ–‡ä»¶"
          mkdir -p ./release-files
          
          # å¤åˆ¶åº”ç”¨ç¨‹åºåŒ…
          cp ./win-file/* ./release-files/ 2>/dev/null || true
          cp ./linux-file/* ./release-files/ 2>/dev/null || true
          cp ./mac-file/* ./release-files/ 2>/dev/null || true
          
          # å¤åˆ¶ updater æ–‡ä»¶
          find . -path "*/updater-linux-amd64/updater-linux-amd64" -exec cp {} ./release-files/ \;
          find . -path "*/updater-linux-arm64/updater-linux-arm64" -exec cp {} ./release-files/ \;
          find . -path "*/updater-windows-amd64.exe/updater-windows-amd64.exe" -exec cp {} ./release-files/ \;
          find . -path "*/updater-macos-amd64/updater-macos-amd64" -exec cp {} ./release-files/ \;
          find . -path "*/updater-macos-arm64/updater-macos-arm64" -exec cp {} ./release-files/ \;

          echo "ðŸ“‹ å‘å¸ƒæ–‡ä»¶åˆ—è¡¨:"
          ls -la ./release-files/

      - name: ðŸ“ Generate version.json
        run: |
          echo "ðŸ“ ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶"
          cat > ./release-files/version.json << EOF
          {
            "version": "${{ needs.set-tag.outputs.tag }}",
            "windows": {
              "download_url": "https://github.com/${{ github.repository }}/releases/download/${{ needs.set-tag.outputs.tag }}/LumenTV-win-${{ needs.set-tag.outputs.tag }}.zip",
              "msi_url": "https://github.com/${{ github.repository }}/releases/download/${{ needs.set-tag.outputs.tag }}/LumenTV-win-${{ needs.set-tag.outputs.tag }}.msi"
            },
            "linux": {
              "download_url": "https://github.com/${{ github.repository }}/releases/download/${{ needs.set-tag.outputs.tag }}/LumenTV-linux-${{ needs.set-tag.outputs.tag }}.zip",
              "deb_url": "https://github.com/${{ github.repository }}/releases/download/${{ needs.set-tag.outputs.tag }}/LumenTV-linux-${{ needs.set-tag.outputs.tag }}.deb"
            },
            "mac": {
              "download_url": "https://github.com/${{ github.repository }}/releases/download/${{ needs.set-tag.outputs.tag }}/LumenTV-mac-${{ needs.set-tag.outputs.tag }}.zip",
              "dmg_url": "https://github.com/${{ github.repository }}/releases/download/${{ needs.set-tag.outputs.tag }}/LumenTV-mac-${{ needs.set-tag.outputs.tag }}.dmg"
            }
          }
          EOF

      - name: ðŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ./release-files/*
          tag_name: ${{ needs.set-tag.outputs.tag }}
          name: "LumenTV ${{ needs.set-tag.outputs.tag }}"
          body: |
            ## LumenTV ${{ needs.set-tag.outputs.tag }} å‘å¸ƒ
            
            ### ðŸ”„ æ›´æ–°å†…å®¹
            - å‘å¸ƒç‹¬ç«‹çš„ updater ç»„ä»¶
            - ä¼˜åŒ–è‡ªåŠ¨æ›´æ–°æµç¨‹
            - ä¿®å¤å·²çŸ¥é—®é¢˜
            
            ### ðŸ“¦ åŒ…å«æ–‡ä»¶
            - Windows: MSI å®‰è£…åŒ…å’Œ ZIP åŽ‹ç¼©åŒ…
            - Linux: DEB åŒ…å’Œ ZIP åŽ‹ç¼©åŒ…  
            - macOS: DMG é•œåƒå’Œ ZIP åŽ‹ç¼©åŒ…
            - Updater: å„å¹³å°ç‹¬ç«‹çš„æ›´æ–°å™¨ç»„ä»¶
            - version.json: ç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
            
            ### ðŸ› ï¸ æŠ€æœ¯è¯´æ˜Ž
            - updater ç»„ä»¶ç‹¬ç«‹å‘å¸ƒï¼Œä¾¿äºŽè‡ªåŠ¨æ›´æ–°ç³»ç»Ÿä½¿ç”¨
            - åº”ç”¨ç¨‹åºåŒ…ä¸åŒ…å« updaterï¼Œå‡å°åŒ…ä½“ç§¯
            - æ”¯æŒæŒ‰éœ€ä¸‹è½½å¯¹åº”å¹³å°çš„ updater
          draft: false
          prerelease: false
    permissions:
      contents: write
